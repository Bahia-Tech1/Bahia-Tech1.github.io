<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C치mara - Modo Servidor</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: sans-serif; text-align: center; overflow: hidden;}
        video { width: 100%; height: 100vh; object-fit: cover; }
        .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input { padding: 15px; font-size: 18px; text-align: center; border-radius: 5px; border: none; margin-bottom: 10px; }
        button { padding: 15px 30px; font-size: 18px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
        #status { margin-top: 20px; font-size: 14px; color: #f1c40f; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="setup-panel" class="panel">
        <h2>游닞 Configurar C치mara</h2>
        <p>Ponle nombre a esta c치mara:</p>
        <input type="text" id="my-name" value="camara-casa" placeholder="Ej: camara1">
        <button onclick="iniciar()">INICIAR</button>
        <p id="status">Esperando...</p>
    </div>

    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        const status = document.getElementById('status');
        const panel = document.getElementById('setup-panel');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let peer = null;
        let localStream = null;

        function iniciar() {
            const id = document.getElementById('my-name').value.trim();
            if(!id) return alert("Escribe un nombre");

            status.innerText = "Conectando...";

            // Configuraci칩n Google STUN
            peer = new Peer(id, {
                config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
            });

            peer.on('open', (myId) => {
                status.innerText = "춰LISTO! Esperando al monitor...";
                status.style.color = "#0f0";
                // Accedemos a la c치mara inmediatamente
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
                .then(stream => {
                    localStream = stream;
                    video.srcObject = stream;
                    setTimeout(() => { panel.style.display = 'none'; }, 2000);
                })
                .catch(err => alert("Error de c치mara: " + err));
            });

            peer.on('error', (err) => {
                alert("Error: " + err.type);
                status.innerText = "Error: " + err.type;
            });

            // ESCUCHAR CONEXIONES (El Timbre)
            peer.on('connection', (conn) => {
                console.log("Monitor conectado: " + conn.peer);
                
                conn.on('data', (data) => {
                    console.log("Comando recibido:", data);
                    
                    // Si el monitor dice "QUIERO_VER", lo llamamos con video
                    if (data === 'QUIERO_VER') {
                        if(localStream) {
                            console.log("Llamando al monitor con video...");
                            peer.call(conn.peer, localStream);
                        }
                    }
                    // Si el monitor dice "FOTO", tomamos foto
                    if (data === 'FOTO') {
                        tomarFoto();
                    }
                });
            });
        }

        function tomarFoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = 'foto.png';
            a.click();
            
            // Flash visual
            const flash = document.createElement('div');
            flash.style.position = 'fixed'; flash.style.top=0; flash.style.left=0; flash.style.width='100%'; flash.style.height='100%'; flash.style.background='white'; flash.style.zIndex=999;
            document.body.appendChild(flash);
            setTimeout(() => flash.remove(), 100);
        }
    </script>
</body>
</html>
