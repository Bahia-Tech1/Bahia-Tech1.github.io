<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CÃ¡mara - Modo Seguro</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: #fff; margin: 0; font-family: sans-serif; text-align: center; overflow: hidden;}
        video { width: 100%; height: 100vh; object-fit: cover; }
        .panel { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        input { padding: 15px; font-size: 18px; text-align: center; border-radius: 5px; border: none; margin-bottom: 10px; }
        button { padding: 15px 30px; font-size: 18px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;}
        #status { margin-top: 20px; font-size: 14px; color: #f1c40f; }
        canvas { display: none; }
    </style>
</head>
<body>

    <div id="setup-panel" class="panel">
        <h2>ðŸ“¸ Configurar CÃ¡mara</h2>
        <p>Ponle un nombre Ãºnico:</p>
        <input type="text" id="my-name" value="camara-casa" placeholder="Ej: camara1">
        <button onclick="iniciar()">INICIAR</button>
        <p id="status">Esperando...</p>
    </div>

    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        const status = document.getElementById('status');
        const panel = document.getElementById('setup-panel');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let peer = null;

        function iniciar() {
            const id = document.getElementById('my-name').value.trim();
            if(!id) return alert("Escribe un nombre");

            status.innerText = "Conectando al servidor...";

            // ConfiguraciÃ³n robusta usando servidores de Google
            peer = new Peer(id, {
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                }
            });

            peer.on('open', (id) => {
                status.innerText = "Â¡CONECTADO! Tu nombre es: " + id;
                status.style.color = "#0f0";
                setTimeout(() => { panel.style.display = 'none'; }, 2000);
            });

            peer.on('error', (err) => {
                if(err.type === 'unavailable-id') {
                    alert("El nombre '" + id + "' ya existe. Â¡Prueba otro!");
                    status.innerText = "Nombre ocupado. Cambialo.";
                } else {
                    alert("Error: " + err.type);
                }
            });

            // Iniciar video
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false })
            .then(stream => {
                video.srcObject = stream;
                peer.on('call', call => call.answer(stream));
                peer.on('connection', conn => {
                    conn.on('data', data => { if(data === 'FOTO') tomarFoto(); });
                });
            });
        }

        function tomarFoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = 'foto.png';
            a.click();
            // Flash
            document.body.style.backgroundColor = "#fff";
            setTimeout(() => document.body.style.backgroundColor = "#000", 100);
        }
    </script>
</body>
</html>
