<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor - Modo Cliente</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background: #222; color: #fff; margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #video-wrap { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; position: relative; }
        video { max-width: 100%; max-height: 100%; }
        #controls { padding: 20px; background: #333; text-align: center; }
        input { padding: 10px; width: 60%; text-align: center; margin-bottom: 10px; }
        button { padding: 10px; width: 100%; font-weight: bold; cursor: pointer; }
        #btnConnect { background: #555; color: #aaa; border: none; }
        #btnConnect.ready { background: #2196F3; color: #fff; }
        .btn-foto { background: #e74c3c; color: white; width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; font-size: 24px; display: none; margin: 0 auto; }
        #log { font-size: 12px; color: #ccc; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="video-wrap">
        <p id="wait-msg" style="display:none;">Esperando video de la cÃ¡mara...</p>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="controls">
        <div id="login-box">
            <p id="log">Iniciando sistema...</p>
            <input type="text" id="target-id" value="camara-casa" placeholder="Nombre cÃ¡mara">
            <br>
            <button id="btnConnect" onclick="conectar()" disabled>ESPERANDO RED...</button>
        </div>
        <button id="btnFoto" class="btn-foto" onclick="pedirFoto()">ðŸ“·</button>
    </div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const log = document.getElementById('log');
        const remoteVideo = document.getElementById('remoteVideo');
        let dataConn = null;

        // Creamos nuestro peer (sin nombre fijo, que sea automÃ¡tico)
        const peer = new Peer(null, {
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
        });

        peer.on('open', (id) => {
            log.innerText = "Red OK.";
            btnConnect.innerText = "CONECTAR";
            btnConnect.disabled = false;
            btnConnect.classList.add('ready');
        });

        peer.on('error', (err) => alert("Error: " + err.type));

        // IMPORTANTE: AquÃ­ contestamos cuando la cÃ¡mara nos devuelva la llamada
        peer.on('call', (call) => {
            document.getElementById('wait-msg').style.display = 'none';
            log.innerText = "Â¡Recibiendo video!";
            call.answer(); // Contestamos sin enviar nada
            call.on('stream', (stream) => {
                remoteVideo.srcObject = stream;
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('btnFoto').style.display = 'block';
            });
        });

        function conectar() {
            const target = document.getElementById('target-id').value.trim();
            if(!target) return;

            log.innerText = "Contactando a " + target + "...";
            btnConnect.disabled = true;

            // 1. Establecer conexiÃ³n de DATOS (Texto)
            dataConn = peer.connect(target);

            dataConn.on('open', () => {
                log.innerText = "Conectado. Pidiendo video...";
                document.getElementById('wait-msg').style.display = 'block';
                // 2. Le pedimos el video
                dataConn.send('QUIERO_VER');
            });

            dataConn.on('error', (err) => {
                alert("No se encontrÃ³ la cÃ¡mara. Â¿EstÃ¡ encendida?");
                btnConnect.disabled = false;
            });
        }

        function pedirFoto() {
            if(dataConn) dataConn.send('FOTO');
        }
    </script>
</body>
</html>
