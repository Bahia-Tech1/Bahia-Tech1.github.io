<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Remoto v2</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: #fff; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        
        #video-container { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #000; }
        video { max-width: 100%; max-height: 100%; border: 2px solid #333; }

        #controls { padding: 20px; background: #333; }
        input { padding: 10px; width: 150px; font-size: 16px; }
        
        .btn-connect { background: #2196F3; color: white; padding: 10px; border: none; cursor: pointer; font-size: 16px; border-radius: 4px;}
        
        .btn-snap { 
            background: #ff4757; color: white; 
            width: 80px; height: 80px; 
            border-radius: 50%; border: 4px solid #fff; 
            font-size: 30px; cursor: pointer; margin-top: 10px;
            display: none; /* Oculto hasta que conecte */
        }
        #status-msg { color: #aaa; margin-top: 10px; font-size: 14px;}
    </style>
</head>
<body>

    <div id="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="controls">
        <div id="connection-panel">
            <h3>Paso 1: Conectar</h3>
            <input type="text" id="remoteId" placeholder="Escribe el ID aqu칤">
            <br><br>
            <button id="btnConnect" class="btn-connect" onclick="conectar()">CONECTAR</button>
        </div>
        
        <p id="status-msg">Esperando ID...</p>

        <button id="btnSnap" class="btn-snap" onclick="enviarOrdenFoto()">游닝</button>
    </div>

    <script>
        // Verificamos si la librer칤a carg칩
        if (typeof Peer === 'undefined') {
            alert("ERROR CR칈TICO: No se carg칩 la librer칤a PeerJS. Revisa tu conexi칩n a internet.");
        }

        const peer = new Peer(); // Creamos nuestro propio ID autom치ticamente
        
        const remoteVideo = document.getElementById('remoteVideo');
        const btnConnect = document.getElementById('btnConnect');
        const statusMsg = document.getElementById('status-msg');
        const connectionPanel = document.getElementById('connection-panel');
        const btnSnap = document.getElementById('btnSnap');
        
        let dataConnection = null;

        // 1. Mensaje si hay error en PeerJS
        peer.on('error', (err) => {
            console.error(err);
            alert("Error de PeerJS: " + err.type);
            statusMsg.innerText = "Error: " + err.type;
            btnConnect.disabled = false;
            btnConnect.innerText = "Reintentar";
        });

        peer.on('open', (id) => {
            console.log("Mi ID local es: " + id);
            statusMsg.innerText = "Listo para conectar. Mi red est치 OK.";
        });

        function conectar() {
            const remoteId = document.getElementById('remoteId').value.trim(); // .trim() quita espacios accidentales
            
            if (!remoteId) {
                return alert("춰Oye! Tienes que escribir el ID de la c치mara primero.");
            }

            // Feedback visual: El usuario sepa que hizo click
            btnConnect.disabled = true;
            btnConnect.innerText = "Conectando...";
            statusMsg.innerText = "Buscando a la c치mara " + remoteId + "...";

            // --- CONEXI칍N DE VIDEO ---
            const call = peer.call(remoteId, null);
            
            if (!call) {
                alert("No se pudo iniciar la llamada. Revisa el ID.");
                btnConnect.disabled = false;
                return;
            }

            call.on('stream', (remoteStream) => {
                statusMsg.innerText = "춰Video recibido!";
                remoteVideo.srcObject = remoteStream;
                // Mostrar controles de c치mara
                connectionPanel.style.display = 'none';
                btnSnap.style.display = 'inline-block';
            });

            call.on('close', () => {
                alert("La llamada se cort칩.");
                location.reload();
            });

            // --- CONEXI칍N DE DATOS (Para el bot칩n) ---
            dataConnection = peer.connect(remoteId);
            
            dataConnection.on('open', () => {
                console.log("Canal de datos abierto");
            });
            
            dataConnection.on('error', (err) => {
                alert("Error en datos: " + err);
            });
        }

        function enviarOrdenFoto() {
            if (dataConnection && dataConnection.open) {
                dataConnection.send('TOMAR_FOTO');
                // Peque침a vibraci칩n si el navegador lo soporta
                if (navigator.vibrate) navigator.vibrate(50);
            } else {
                alert("Error: No hay conexi칩n de datos con la c치mara.");
            }
        }
    </script>
</body>
</html>
