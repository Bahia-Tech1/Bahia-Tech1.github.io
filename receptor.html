<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control - Modo Seguro</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { background: #222; color: #fff; margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #video-wrap { flex: 1; background: #000; display: flex; justify-content: center; align-items: center; }
        video { max-width: 100%; max-height: 100%; }
        #controls { padding: 20px; background: #333; text-align: center; }
        input { padding: 10px; width: 60%; text-align: center; margin-bottom: 10px; }
        
        /* Bot贸n deshabilitado (gris) por defecto */
        #btnConnect { padding: 10px 20px; background: #555; color: #aaa; border: none; cursor: not-allowed; width: 100%; font-weight: bold; }
        /* Clase para habilitarlo (azul) */
        #btnConnect.ready { background: #2196F3; color: #fff; cursor: pointer; }
        
        .btn-foto { background: #e74c3c; color: white; width: 80px; height: 80px; border-radius: 50%; border: 4px solid white; font-size: 24px; display: none; margin: 0 auto; cursor: pointer; }
        
        #log { font-size: 12px; color: #ccc; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="video-wrap">
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="controls">
        <div id="login-box">
            <p id="log">Conectando a la red...</p>
            <input type="text" id="target-id" value="camara-casa" placeholder="Nombre de la c谩mara">
            <br>
            <button id="btnConnect" onclick="conectar()" disabled>ESPERANDO RED...</button>
        </div>
        <button id="btnFoto" class="btn-foto" onclick="pedirFoto()"></button>
    </div>

    <script>
        const btnConnect = document.getElementById('btnConnect');
        const log = document.getElementById('log');
        const remoteVideo = document.getElementById('remoteVideo');
        let dataConn = null;

        // Configuraci贸n con servidores Google
        const peer = new Peer(null, {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        // 1. Cuando MI tel茅fono tiene se帽al con el servidor
        peer.on('open', (id) => {
            log.innerText = "Red OK. Mi ID: " + id;
            log.style.color = "#4CAF50";
            // Habilitamos el bot贸n
            btnConnect.innerText = "CONECTAR A CMARA";
            btnConnect.disabled = false;
            btnConnect.classList.add('ready');
        });

        peer.on('error', (err) => {
            log.innerText = "Error de red: " + err.type;
            alert("Error: " + err.type);
        });

        function conectar() {
            const target = document.getElementById('target-id').value.trim();
            if(!target) return;

            log.innerText = "Llamando a " + target + "...";
            btnConnect.innerText = "Llamando...";

            // Llamada de Video
            const call = peer.call(target, null);
            
            if(!call) {
                return alert("Error interno: No se pudo generar la llamada.");
            }

            call.on('stream', (stream) => {
                log.innerText = "隆Video recibido!";
                remoteVideo.srcObject = stream;
                document.getElementById('login-box').style.display = 'none';
                document.getElementById('btnFoto').style.display = 'block';
            });

            call.on('error', (err) => alert("Error llamada: " + err));

            // Canal de datos para el bot贸n
            dataConn = peer.connect(target);
        }

        function pedirFoto() {
            if(dataConn) dataConn.send('FOTO');
        }
    </script>
</body>
</html>
